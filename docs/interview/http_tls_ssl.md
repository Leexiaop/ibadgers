---
title: TLS/SSL的加密过程
group: HTTP
toc: content
---

TLS/SSL 全称为安全传输协议，是介于 tcp 和 http 之间的一层安全协议，不会影响到
http 和 tcp，因此使用 https 基本上不需要对 http 页面做太多的修改。

TLS/SSL 的功能实现主要依赖三类基本算法：散列函数 hash，对称加密和非对称加密。

- 基于散列函数来验证信息的完整性
- 对称加密算法采用协商密钥对数据加密
- 非对称加密实现身份的验证和密钥协商

<!-- ![TLS/SSL加密](https://leexiaop.github.io/static/ibadgers/interview/http_ssl.jpg) -->

![TLS/SSL加密](https://leexiaop.github.io/static/ibadgers/interview/http_ssl.jpg)

#### 散列函数

常见的散列函数有 md5,SHA1,SHA256。该函数的特点是单向不可逆。对输入的数据非常敏感
。输出的长度固定。任何数据的修改都会改变散列函数的结果。可以用于防止信息篡改并验
证数据的完整性。

特点：在信息传输的过程中，散列函数不能都实现信息防篡改，由于传输的信息是明文传输
，中间人可以修改信息后重新计算信息的摘要，所以需要对传输的信息和信息摘要进行加密
。

#### 对称加密

对称加密的方法是，双方使用同一个密钥对数据进行加密和解密，但是对称加密存在一个问
题，就是如何保证密钥传输的安全性，因为密钥还是会通过网络传输，一旦密钥被其他人获
取到，那么整个加密过程就毫无作用了。这就是用到非对称加密的方法。

常见的对称加密算法有 AES-CBC，DES，3DES，AES-GCM 等，相同的密钥可以用于对信息的
加密和解密，掌握密钥才能获取信息，防止窃听，其通讯方式是一对一。

特点：对称加密的优势就是信息传输使用一对一。需要共享相同的密码，密码的安全就是保
证信息安全的基础，服务器和 n 个客户端通信，需要维持 n 个密码记录且不能修改密码。

#### 非对称加密

非对称加密的方法是，我们拥有俩个密钥，一个是公钥，一个是私钥，公钥是公开的，私钥
是保密的，用私钥加密的数据，只有对应的公钥才能解开，用公钥加密的数据，只有对应的
私钥才能解密，我们可以将公钥公布出去，任何想要和我们通信的客户都可以使用我们提供
的公钥对数据进行加密。这样我们就可以使用私钥进行解密，这样也就保证了数据的安全性
。但是非对称加密有一个缺点就是加密过程很慢，因此如果每次通信都是用非对称加密的方
式的话，反而会造成等待时间过长的问题。

常见的非对称加密算法有 RSA，ECC，DH 等，密钥成对的出现，一般称为公钥和私钥，公钥
加密的信息只有私钥可以解开，私钥加密的信息只有公钥可以解开。因此掌握公钥的不同客
户端之间不能相互解密，只有和服务器进行加密通信，服务器可以实现一对多的通信，客户
端也可以用来验证掌握私钥的服务器身份。

特点：非对称加密的特点是一对多。服务器只需要维护一个私钥就可以和多个客户端进行通
信，但是服务器发出的信息能够被所有客户端解密，且该算法计算复杂，加密的速度慢。

综合上述算法的特点，TLS/SS 的工作方式就是客户端使用非对称加密与服务器端进行通信
，实现身份的验证并协商对称加密使用的密钥，对称加密算法采用协商密钥对信息以及信息
摘要进行加密通信，不同节点之间采用的对称密钥不同，从而保证信息只能通信双方获取，
这样就解决了俩个方法各自存在的问题。

#### TLS/SSL 加密的过程

- 浏览器将自己支持的一套加密规则发送给服务端
- 服务端从中选出一组加密算法和 HASH 算法，并将自己的身份信息以证书的形式发回给
  浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。
- 获得网站证书之后浏览器要做以下工作：

  - a) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与
    正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，
    否则会给出证书不受信的提示。

  - b) 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数
    的密码，并用证书中提供的公钥加密。

  - c) 使用约定好的 HASH 计算握手消息，并使用生成的随机数对消息进行加密，最
    后将之前生成的所有信息发送给服务端。

- 服务端接收浏览器发来的数据之后要做以下的操作：

  - a) 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，
    并验证 HASH 是否与浏览器发来的一致。

  - b) 使用密码加密一段握手消息，发送给浏览器。

- 浏览器解密并计算握手消息的 HASH，如果与服务端发来的 HASH 一致，此时握手过程
  结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加
  密。

这里浏览器与服务器互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的
密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。
